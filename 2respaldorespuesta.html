<!DOCTYPE html>
<html lang="es">
<head>
   <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8" />
  <title>YOUR TOURS - Comprobante de Pago</title>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Tus estilos CSS existentes permanecen igual */
    body {
      margin: 0;
      padding: 2rem;
      background: linear-gradient(to right, #f8f9fa, #f8f9fa);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      font-family: 'Archivo', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    /* ... (mant√©n todos tus estilos existentes) ... */
    
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <!-- Contenedor padre con separaci√≥n -->
  <div class="ticket-container">
    <div class="ticket">
      <div class="stripe top"></div>
      <div class="stripe bottom"></div>
      <div class="left">
        
        <div class="section row">
          <div class="info-block">
            <div class="label">Estado</div>
            <div class="value" id="estado">Verificando...</div>
          </div>
          <div class="info-block">
            <div class="label">Autorizaci√≥n</div>
            <div class="value" id="autorizacion">‚Äî</div>
          </div>
        </div>

        <div class="section row">
          <div class="info-block">
            <div class="label">Transacci√≥n ID</div>
            <div class="value" id="transaccionId">‚Äî</div>
          </div>
          <div class="info-block">
            <div class="label">Identificador Cliente</div>
            <div class="value" id="clientTxId">‚Äî</div>
          </div>
        </div>

        <div class="section row">
          <div class="info-block">
            <div class="label">Cliente</div>
            <div class="value" id="cliente">‚Äî</div>
          </div>
          <div class="info-block">
            <div class="label">Email</div>
            <div class="value" id="email">‚Äî</div>
          </div>
        </div>

        <div class="section row">
          <div class="info-block">
            <div class="label">Tel√©fono</div>
            <div class="value" id="telefono">‚Äî</div>
          </div>
          <div class="info-block">
            <div class="label">Fecha</div>
            <div class="value" id="fecha">‚Äî</div>
          </div>
        </div>

        <div class="section row">
          <div class="info-block">
            <div class="label">Banco / Marca</div>
            <div class="value" id="banco">‚Äî</div>
          </div>
          <div class="info-block">
            <div class="label">√öltimos d√≠gitos</div>
            <div class="value" id="ultimos">‚Äî</div>
          </div>
        </div>

        <div class="section row">
          <div class="info-block" style="flex: 1 1 100%;">
            <div class="label">Referencia</div>
            <div class="value" id="referencia">‚Äî</div>
          </div>
        </div>

        <button class="print-button" onclick="window.print()" aria-label="Imprimir Comprobante">
          üñ®Ô∏è Imprimir
        </button>

        <div class="barcode">
          <svg id="barcode"></svg>
          <div id="barcode-text" class="barcode-text"></div>
        </div>

        <div class="thank-you">¬°La vida se mide en experiencias!</div>
      </div>
    </div>

    <div class="ticket">
       <div class="stripe top"></div>
      <div class="stripe bottom"></div>

      <div class="right">
        <span class="aro" style="width: 80px; height: 80px; top: -35px; left: 30px;"></span>
        <span class="aro" style="width: 60px; height: 60px; top: 130px; right: -20px;"></span>
        <span class="aro" style="width: 250px; height: 250px; bottom: 40px; left: 120px;"></span>
        <span class="aro" style="width: 50px; height: 50px; bottom: -50px; right: 280px;"></span>
        <span class="aro" style="width: 120px; height: 120px; top: 50%; left: 10%; transform: translate(-50%, -50%);"></span>

        <div class="comprobantedepago"><h1>Comprobante de Pago</h1> </div> 
        
        <img src="img/logo sin fondo.png" class="logo-right" alt="Logo Your Tours" />
        <div>
          <div class="totalpagado">Total Pagado</div>
          <div class="amount" id="monto">$--</div>
          <div class="incluyeimpuestos"></div>
        </div>
        <div class="website">www.yourtours.com.ec</div>
      </div>
    </div>
  </div>

  <script>
    // URL de tu script de Google Apps Script (debes reemplazarla)
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwbqiw7znxNsXi9Hhsl_p-JrS780NCiPwDMPvBevEN2yDc_Da3ZCkQXRYL6bUjl_PtB/exec";
    
    const params = new URLSearchParams(window.location.search);
    const id = parseInt(params.get("id") || 0);
    const clientTransactionId = params.get("clientTransactionId") || "";

    function setEstado(text, aprobado) {
      const el = document.getElementById("estado");
      el.textContent = text;
      el.classList.remove("aprobado", "fallido");
      if (aprobado === true) el.classList.add("aprobado");
      else if (aprobado === false) el.classList.add("fallido");
    }

    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleString("es-EC", {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString || "‚Äî";
      }
    }

    if (id && clientTransactionId) {
      fetch(BACKEND_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: id,
          clientTxId: clientTransactionId
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }

        // Actualizar UI con los datos de la respuesta
        if (data.transactionStatus === "Approved") {
          setEstado("‚úÖ Transacci√≥n aprobada", true);
        } else {
          setEstado(`‚ùå Transacci√≥n ${data.transactionStatus || "fallida"}`, false);
        }

        document.getElementById("monto").textContent = `$${(data.amount / 100).toFixed(2)} ${data.currency || ""}`;
        document.getElementById("autorizacion").textContent = data.authorizationCode || "‚Äî";
        document.getElementById("transaccionId").textContent = data.transactionId || "‚Äî";
        document.getElementById("clientTxId").textContent = data.clientTransactionId || "‚Äî";

        // Generar c√≥digo de barras
        JsBarcode("#barcode", data.clientTransactionId?.toString() || "0000000000", {
          format: "CODE128",
          lineColor: "#000",
          width: 2,
          height: 40,
          displayValue: false
        });
        document.getElementById("barcode-text").textContent = data.clientTransactionId || "0000000000";

        document.getElementById("cliente").textContent = data.optionalParameter4 || "No registrado";
        document.getElementById("email").textContent = data.email || "No disponible";
        document.getElementById("telefono").textContent = data.phoneNumber || "‚Äî";
        document.getElementById("fecha").textContent = formatDate(data.date);
        document.getElementById("banco").textContent = data.cardBrand || "‚Äî";
        document.getElementById("ultimos").textContent = data.lastDigits || "‚Äî";
        document.getElementById("referencia").textContent = data.reference || "‚Äî";
      })
      .catch(error => {
        setEstado("‚ö†Ô∏è Error al verificar la transacci√≥n", false);
        console.error("Error:", error);
        document.getElementById("estado").textContent = `‚ö†Ô∏è ${error.message}`;
      });
    } else {
      setEstado("‚ùå Faltan par√°metros en la URL (id y clientTransactionId)", false);
    }
  </script>
</body>
</html>
