<!DOCTYPE html>
<html lang="es">
<!-- [HEAD y CSS se mantienen igual que en tu código original] -->
<body>
  <!-- [Todo el HTML de tu comprobante se mantiene igual] -->

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id") || "0";
    const clientTransactionId = params.get("clientTransactionId") || "";

    // URL de tu Google Apps Script publicado (REEMPLAZA ESTO)
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxXtXNWnm_IIbdW0GC0NpDb0NVbov-D9CYgawwF8gN787rTTPxksWlMuuGd7XSLBrD7/exec";

    function setEstado(text, aprobado) {
      const el = document.getElementById("estado");
      el.textContent = text;
      el.classList.remove("aprobado", "fallido");
      if (aprobado === true) el.classList.add("aprobado");
      else if (aprobado === false) el.classList.add("fallido");
    }

    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleString("es-EC", {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return dateString || "—";
      }
    }

    if (id && clientTransactionId) {
      // Usamos GET en lugar de POST para evitar problemas CORS
      fetch(`${BACKEND_URL}?id=${id}&clientTransactionId=${clientTransactionId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          throw new Error(data.error);
        }

        if (data.transactionStatus === "Approved") {
          setEstado("✅ Transacción aprobada", true);
        } else {
          setEstado(`❌ Transacción ${data.transactionStatus || "fallida"}`, false);
        }

        document.getElementById("monto").textContent = `$${(data.amount / 100).toFixed(2)} ${data.currency || ""}`;
        document.getElementById("autorizacion").textContent = data.authorizationCode || "—";
        document.getElementById("transaccionId").textContent = data.transactionId || "—";
        document.getElementById("clientTxId").textContent = data.clientTransactionId || "—";

        // Generar código de barras
        JsBarcode("#barcode", data.clientTransactionId?.toString() || "0000000000", {
          format: "CODE128",
          lineColor: "#000",
          width: 2,
          height: 40,
          displayValue: false
        });
        document.getElementById("barcode-text").textContent = data.clientTransactionId || "0000000000";

        document.getElementById("cliente").textContent = data.optionalParameter4 || "No registrado";
        document.getElementById("email").textContent = data.email || "No disponible";
        document.getElementById("telefono").textContent = data.phoneNumber || "—";
        document.getElementById("fecha").textContent = formatDate(data.date);
        document.getElementById("banco").textContent = data.cardBrand || "—";
        document.getElementById("ultimos").textContent = data.lastDigits || "—";
        document.getElementById("referencia").textContent = data.reference || "—";
      })
      .catch(error => {
        setEstado(`⚠️ ${error.message}`, false);
        console.error("Error al verificar:", error);
      });
    } else {
      setEstado("❌ Faltan parámetros en la URL (id y clientTransactionId)", false);
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</body>
</html>
