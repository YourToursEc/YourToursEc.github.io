<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Your Tours - Reserva y Pago</title>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- PayPhone Box -->
  <script src="https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.js" type="module"></script>
  <link href="https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.css" rel="stylesheet">

  <style>
    .container-fluid.booking {
      margin-top: 2rem;
      padding-bottom: 3rem;
    }
    .custom-select, .form-control {
      height: 47px;
    }
    #btn-pagar {
      margin-top: 1rem;
    }
    #pp-button {
      margin-top: 2rem;
    }
  </style>
</head>
<body>

<div class="container-fluid booking">
  <div class="container">
    <div class="bg-light shadow p-4">
      <div class="row">
        <!-- Región -->
        <div class="col-md-3 mb-2">
          <select id="region-select" class="custom-select px-4">
            <option selected disabled>Elige una región</option>
            <option value="Costa">Costa</option>
            <option value="Sierra">Sierra</option>
            <option value="Amazonía">Amazonía</option>
            <option value="Galápagos">Galápagos</option>
            <option value="Internacional">Internacional</option>
          </select>
        </div>

        <!-- Destino -->
        <div class="col-md-3 mb-2">
          <select id="destino-select" class="custom-select px-4">
            <option selected disabled>Selecciona un destino</option>
          </select>
        </div>

        <!-- Fecha -->
        <div class="col-md-3 mb-2">
          <input type="text" id="fecha-calendario" class="form-control p-4" placeholder="Fecha de salida" readonly />
        </div>

        <!-- Precio -->
        <div class="col-md-3 mb-2">
          <input type="text" id="precio-pagar" class="form-control p-4" placeholder="Precio total a pagar" readonly />
        </div>

        <!-- Botón -->
        <div class="col-md-12">
          <button id="btn-pagar" class="btn btn-success btn-block">Pagar con Tarjeta</button>
        </div>
      </div>
      <div id="pp-button"></div>
    </div>
  </div>
</div>

<script>
  const regiones = {
    "Costa": ["Puerto Lopes", "Playas", "Manta"],
    "Sierra": ["Cuenca", "Cotopaxi", "Chimborazo"],
    "Amazonía": ["Tena", "Puyo", "Cuyabeno"],
    "Galápagos": ["Isabela", "Santa Cruz", "San Cristóbal"],
    "Internacional": ["Cartagena", "Cancún", "Machu Picchu"]
  };

  const preciosBase = {
    "Cotopaxi": 42.61,
    "Cuenca": 156.52,
    "Chimborazo": 33.91
  };

  const regionSelect = document.getElementById('region-select');
  const destinoSelect = document.getElementById('destino-select');
  const fechaInput = document.getElementById('fecha-calendario');
  const precioInput = document.getElementById('precio-pagar');
  const btnPagar = document.getElementById('btn-pagar');

  flatpickr(fechaInput, {
    dateFormat: "Y-m-d",
    minDate: "today"
  });

  regionSelect.addEventListener('change', () => {
    const destinos = regiones[regionSelect.value] || [];
    destinoSelect.innerHTML = '<option selected disabled>Selecciona un destino</option>';
    destinos.forEach(dest => {
      const option = document.createElement('option');
      option.value = dest;
      option.textContent = dest;
      destinoSelect.appendChild(option);
    });
    precioInput.value = '';
  });

  destinoSelect.addEventListener('change', calcularPrecio);
  fechaInput.addEventListener('change', calcularPrecio);

  function calcularPrecio() {
    const destino = destinoSelect.value;
    const fecha = fechaInput.value;
    if (!destino || !fecha) {
      precioInput.value = '';
      return;
    }

    let base = preciosBase[destino] || 0;
    if (base > 0) {
      const ivaBase = base * 0.15;
      const subtotal = base + ivaBase;

      const comision = subtotal * 0.05;
      const ivaComision = comision * 0.15;

      const total = subtotal + comision + ivaComision;
      precioInput.value = `$${total.toFixed(2)}`;
    } else {
      precioInput.value = 'Consultar';
    }
  }

  btnPagar.addEventListener('click', () => {
    const region = regionSelect.value;
    const destino = destinoSelect.value;
    const fecha = fechaInput.value;
    const precioTexto = precioInput.value;

    if (!region || !destino || !fecha || !precioTexto || precioTexto === 'Consultar') {
      alert("Por favor completa todos los campos correctamente.");
      return;
    }

    let base = preciosBase[destino];
    const ivaBase = base * 0.15;
    const subtotal = base + ivaBase;

    const comision = subtotal * 0.05;
    const ivaComision = comision * 0.15;

    const total = subtotal + comision + ivaComision;

    const amount = Math.round(total * 100);
    const amountWithoutTax = Math.round(base * 100);

    document.getElementById("pp-button").innerHTML = "";

    new PPaymentButtonBox({
      token: 'PLVIDA',
      storeId: 'TU_STORE_ID',
      clientTransactionId: `YT-${Date.now()}-${Math.floor(Math.random() * 100000)}`,
      amount: amount,
      amountWithoutTax: amountWithoutTax,
      currency: "USD",
      reference: `Reserva ${destino} (${fecha})`
    }).render('pp-button');
  });
</script>

</body>
</html>