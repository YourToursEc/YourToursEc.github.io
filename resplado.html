<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva y Pago</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body { margin-top: 0rem; }
    .container-fluid.booking { margin-top: 2rem; padding-bottom: 0rem; }
    .custom-select, .form-control { height: 47px; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    #btn-pagar {
      margin-top: 1rem; height: 47px; width: 100%;
      background: linear-gradient(135deg, #28a745 0%, #5cb85c 100%);
      color: white; border: none; border-radius: 12px;
      cursor: pointer; font-size: 16px; font-weight: 600;
      letter-spacing: 0.5px; transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    #btn-pagar:hover {
      background: linear-gradient(135deg, #2dca4f 0%, #5cd85c 100%);
      transform: translateY(-2px); box-shadow: 0 6px 16px rgba(45, 202, 79, 0.4);
    }
    #btn-pagar:active { transform: translateY(0); }
    #pp-button { /* Para mostrar mensajes de estado */
      margin-top: 1rem; text-align: center;
      font-weight: bold; color: #dc3545;
    }
    .flex-row-inputs { display: flex; flex-wrap: wrap; gap: 15px; }
    .flex-row-inputs > * { flex: 1 1 100%; }
    @media (min-width: 768px) {
      body { margin-top: 7rem; }
      .flex-row-inputs > * { flex: 1 1 0; }
    }
    #region-select, #destino-select, #fecha-calendario,
    #precio-pagar, #tipo-experiencia, #numero-personas {
      flex: 1 1 0; padding: 12px 15px; font-size: 1rem;
      border: 2px solid #b9b9b9; border-radius: 12px;
      box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background-color: #f9fff9; color: #155724;
      font-weight: 600; outline: none; margin: 0;
      background-repeat: no-repeat; background-position: right 15px center; background-size: 20px;
    }
    /* Iconos SVG para los inputs */
    #fecha-calendario { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z'/%3E%3C/svg%3E"); }
    #numero-personas {
      padding-left: 50px !important;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05.02.01.03.03.04.04 1.14.83 1.93 1.94 1.93 3.41V18c0 .35-.07.69-.18 1H22c.55 0 1-.45 1-1v-1.5c0-2.33-4.67-3.5-7-3.5z'/%3E%3C/svg%3E");
      background-position: left 15px center;
    }
    #precio-pagar {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/%3E%3C/svg%3E");
      background-color: #d4edda; cursor: not-allowed;
    }
    #region-select:focus, #destino-select:focus,
    #fecha-calendario:focus, #precio-pagar:focus,
    #tipo-experiencia:focus, #numero-personas:focus {
      border-color: #0f5132; box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2); background-color: #e6f4ea;
    }
    #fecha-calendario::placeholder, #precio-pagar::placeholder { color: #6c757d; font-weight: 400; }
    .fechas-disponibles {
      background-color: #d4edda !important; color: #155724 !important;
      border-radius: 50% !important; transition: all 0.2s ease;
    }
    .fechas-disponibles:hover {
      border: 2px solid #28a745 !important; box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3) !important;
      background-color: #a5d6a7 !important; transform: scale(1.05); cursor: pointer;
    }
  </style>
</head>
<body>
  <div>
    <div class="container-fluid booking">
      <div class="container">
        <div class="row align-items-center" style="min-height: 60px;">
          <div class="col-md-12">
            <div class="flex-row-inputs">
              <select id="region-select">
                <option selected disabled>Elige una regi칩n</option>
                <option value="Sierra">Sierra</option>
                <option value="Costa">Costa</option>
                <option value="Amazon칤a">Amazon칤a</option>
                <option value="Internacional">Internacional</option>
              </select>

              <select id="destino-select" disabled>
                <option selected disabled>Elige destino</option>
              </select>

              <select id="tipo-experiencia" disabled>
                <option selected disabled>Tipo de experiencia</option>
              </select>

              <input type="text" id="fecha-calendario" placeholder="Fecha salida" readonly disabled />
              <div style="position: relative; flex: 1 1 0; max-width: 100%;">
                <input
                  type="number"
                  id="numero-personas"
                  min="1"
                  max="99"
                  value="1"
                  placeholder="N칰mero de personas"
                  style="padding-left: 60px; padding-right: 20px; width: 100%; font-size: 1rem; border: 2px solid #b9b9b9; border-radius: 12px; box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2); transition: border-color 0.3s ease, box-shadow 0.3s ease; background-color: #f9fff9; color: #155724; font-weight: 600; outline: none; height: 48px;">
                <span
                  style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; font-weight: 600; font-size: 1.2rem;">
                  游논
                </span>
              </div>
              <input type="text" id="precio-pagar" placeholder="Total a pagar" readonly />
            </div>
            <div class="row">
              <div class="col-md-12">
                <button id="btn-pagar" class="btn btn-success btn-block" style="height: 47px;">
                  Pagar con Tarjeta
                </button>
                <div id="pp-button"></div> </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ** MUY IMPORTANTE: REEMPLAZA ESTA URL CON LA URL DE TU SCRIPT WEB DE GOOGLE APPS SCRIPT **
    // Para obtener esta URL:
    // 1. En tu proyecto de Google Apps Script, haz clic en "Implementar" (Deploy) en la esquina superior derecha.
    // 2. Selecciona "Nueva implementaci칩n" (New deployment).
    // 3. En "Tipo de implementaci칩n", elige "Aplicaci칩n web" (Web app).
    // 4. Configura "Ejecutar como" (Execute as) en "Yo" (My self).
    // 5. Configura "Qui칠n tiene acceso" (Who has access) en "Cualquier persona" (Anyone).
    // 6. Haz clic en "Implementar" (Deploy).
    // 7. Se te mostrar치 una ventana con la "URL de la aplicaci칩n web". C칩piala y p칠gala aqu칤.
    //    Si ya tienes una implementaci칩n, puedes editarla y copiar la URL.
    const GOOGLE_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyGAF0cnwE_MCGoVN789wc1p6Y2W0n56Dy1U8ZggndED1awCByP3rDBRXFtA0ie_taE/exec'; // <-- 춰NO OLVIDES PEGAR TU URL AQU칈!

    // Funciones para generar fechas disponibles (manteniendo tu l칩gica actual)
    function generarFechasBa침osTodoIncluido() {
      const fechasManuales = [
        '2025-06-15', '2025-06-19', '2025-06-22', '2025-06-26',
        '2025-06-29', '2025-07-03', '2025-07-06', '2025-07-10',
        '2025-07-13', '2025-07-17', '2025-07-20', '2025-07-24',
        '2025-07-27', '2025-07-31', '2025-08-03', '2025-08-07',
        '2025-08-10', '2025-08-14', '2025-08-17', '2025-08-21',
        '2025-08-24', '2025-08-28', '2025-08-31'
      ];
      const fechasValidas = [];
      const ahora = new Date(); // Usar fecha actual real
      for (const fechaStr of fechasManuales) {
        const fecha = new Date(fechaStr);
        const fechaCorte = new Date(fecha);
        fechaCorte.setDate(fechaCorte.getDate() - 1);
        fechaCorte.setHours(17, 0, 0, 0); // 5 PM del d칤a anterior
        if (ahora <= fechaCorte) {
          fechasValidas.push(fechaStr);
        }
      }
      return fechasValidas;
    }

    function generarFechasBa침osCompartido() {
      const fechasManuales = [
        '2025-06-18', '2025-06-21', '2025-06-25', '2025-06-28',
        '2025-07-02', '2025-07-05', '2025-07-09', '2025-07-12',
        '2025-07-16', '2025-07-19', '2025-07-23', '2025-07-26',
        '2025-07-30', '2025-08-02', '2025-08-06', '2025-08-09',
        '2025-08-13', '2025-08-16', '2025-08-20', '2025-08-23',
        '2025-08-27', '2025-08-30'
      ];
      const fechasValidas = [];
      const ahora = new Date(); // Usar fecha actual real
      for (const fechaStr of fechasManuales) {
        const fecha = new Date(fechaStr);
        const fechaCorte = new Date(fecha);
        fechaCorte.setDate(fechaCorte.getDate() - 1);
        fechaCorte.setHours(17, 0, 0, 0); // 5 PM del d칤a anterior
        if (ahora <= fechaCorte) {
          fechasValidas.push(fechaStr);
        }
      }
      return fechasValidas;
    }

    // Datos de la aplicaci칩n para regiones, destinos, tipos y precios
    const fechasDisponibles = {
      "Ba침os de Agua Santa": function(tipoExperiencia) {
        if (tipoExperiencia === "Todo Incluido") {
          return generarFechasBa침osTodoIncluido();
        } else if (tipoExperiencia === "Compartido") {
          return generarFechasBa침osCompartido();
        }
        return [];
      },
    };

    const regiones = {
      "Sierra": ["Cotopaxi", "Cuenca", "Chimborazo", "Quilotoa", "Papallacta", "Mitad del Mundo"],
      "Amazon칤a": ["Misahualli", "Ba침os de Agua Santa", "Cotundo"],
      "Internacional": ["Proximamente"],
      "Costa": ["Puerto Lopez", "Atacames"]
    };

    const tiposExperiencia = {
      "Ba침os de Agua Santa": ["Todo Incluido", "Compartido"],
      "_default": ["Todo Incluido"] // Tipo de experiencia por defecto
    };

    const preciosBase = {
      "Ba침os de Agua Santa": {
        "Todo Incluido": {
          finDeSemana: 30,
          entreSemana: 60
        },
        "Compartido": {
          finDeSemana: 100,
          entreSemana: 200
        }
      },
    };

    // Elementos del DOM
    const regionSelect = document.getElementById('region-select');
    const destinoSelect = document.getElementById('destino-select');
    const tipoExperienciaSelect = document.getElementById('tipo-experiencia');
    const fechaInput = document.getElementById('fecha-calendario');
    const numeroPersonasInput = document.getElementById('numero-personas');
    const precioInput = document.getElementById('precio-pagar');
    const btnPagar = document.getElementById('btn-pagar');
    const ppButtonDiv = document.getElementById("pp-button");

    let priceBaseCentavos = 0;
    let numeroPersonas = 1;
    let calendario;

    // --- L칩gica de eventos para los selectores ---
    regionSelect.addEventListener('change', () => {
      const destinos = regiones[regionSelect.value] || [];
      destinoSelect.innerHTML = '<option selected disabled>Elige destino</option>';
      destinos.forEach(dest => {
        const opt = document.createElement('option');
        opt.value = dest;
        opt.textContent = dest;
        destinoSelect.appendChild(opt);
      });
      destinoSelect.disabled = destinos.length === 0;
      tipoExperienciaSelect.innerHTML = '<option selected disabled>Tipo de experiencia</option>';
      tipoExperienciaSelect.disabled = true;
      fechaInput.value = '';
      fechaInput.disabled = true;
      precioInput.value = '';
      if (calendario) calendario.destroy();
      ppButtonDiv.innerHTML = "";
    });

    destinoSelect.addEventListener('change', () => {
      const destino = destinoSelect.value;
      const tipos = tiposExperiencia[destino] || tiposExperiencia["_default"];
      tipoExperienciaSelect.innerHTML = '<option selected disabled>Tipo de experiencia</option>';
      tipos.forEach(tipo => {
        const opt = document.createElement('option');
        opt.value = tipo;
        opt.textContent = tipo;
        tipoExperienciaSelect.appendChild(opt);
      });
      tipoExperienciaSelect.disabled = tipos.length === 0;
      fechaInput.value = '';
      fechaInput.disabled = true;
      precioInput.value = '';
      if (calendario) calendario.destroy();
      ppButtonDiv.innerHTML = "";
    });

    tipoExperienciaSelect.addEventListener('change', () => {
      const destino = destinoSelect.value;
      const tipoExperiencia = tipoExperienciaSelect.value;

      let fechas;
      if (typeof fechasDisponibles[destino] === 'function') {
        fechas = fechasDisponibles[destino](tipoExperiencia);
      } else {
        fechas = fechasDisponibles[destino];
      }

      if (calendario) calendario.destroy();

      if (fechas && fechas.length > 0) {
        calendario = flatpickr(fechaInput, {
          dateFormat: "Y-m-d",
          minDate: "today",
          enable: fechas,
          onOpen: () => { ajustarAlturaIframe(400); },
          onClose: () => { ajustarAlturaIframe(190); },
          onDayCreate: function (dObj, dStr, fp, dayElem) {
            const fecha = dayElem.dateObj.toISOString().split('T')[0];
            if (fechas.includes(fecha)) {
              dayElem.classList.add('fechas-disponibles');
            }
          }
        });
      } else {
        calendario = flatpickr(fechaInput, {
          dateFormat: "Y-m-d",
          minDate: "today",
          onOpen: () => { ajustarAlturaIframe(400); },
          onClose: () => { ajustarAlturaIframe(190); }
        });
      }

      fechaInput.disabled = false;
      precioInput.value = '';
      ppButtonDiv.innerHTML = "";
    });

    fechaInput.addEventListener('change', () => {
      calcularYMostrarPrecio();
      ppButtonDiv.innerHTML = "";
    });

    numeroPersonasInput.addEventListener('change', () => {
      if (parseInt(numeroPersonasInput.value) < 1 || isNaN(parseInt(numeroPersonasInput.value))) {
        numeroPersonasInput.value = 1;
      }
      if (fechaInput.value) {
        calcularYMostrarPrecio();
        ppButtonDiv.innerHTML = "";
      }
    });

    // --- Funci칩n para calcular el precio y montos para PayPhone ---
    function calcularYMostrarPrecio() {
      const destino = destinoSelect.value;
      const tipoExperiencia = tipoExperienciaSelect.value;
      const fecha = fechaInput.value;
      numeroPersonas = parseInt(numeroPersonasInput.value) || 1;

      if (!destino || !fecha || !tipoExperiencia) {
        precioInput.value = '';
        priceBaseCentavos = 0; // Reinicia a 0 si faltan campos
        return;
      }

      const fechaObj = new Date(fecha);
      const diaSemana = fechaObj.getDay();
      const esFinDeSemana = (diaSemana === 6 || diaSemana === 0); // 0: Domingo, 6: S치bado

      let precioBase;
      const precioDestino = preciosBase[destino];

      if (precioDestino && typeof precioDestino === 'object' && precioDestino[tipoExperiencia]) {
        if (typeof precioDestino[tipoExperiencia] === 'object') {
          precioBase = esFinDeSemana ?
            precioDestino[tipoExperiencia].finDeSemana :
            precioDestino[tipoExperiencia].entreSemana;
        } else {
          precioBase = precioDestino[tipoExperiencia];
        }
      } else if (typeof precioDestino === 'number') {
        precioBase = precioDestino;
      } else {
        precioBase = 0;
      }

      if (!precioBase || precioBase <= 0) {
        precioInput.value = 'Consultar';
        priceBaseCentavos = 0;
        return;
      }

      // Calcula los montos en centavos para PayPhone
      const priceBaseEuros = precioBase * numeroPersonas; // Precio base por el n칰mero de personas (en moneda entera)
      priceBaseCentavos = Math.round(priceBaseEuros * 100); // Convertir a centavos (ej: $10.00 -> 1000)

      const iva = Math.round(priceBaseCentavos * 0.15); // IVA del 15% del monto sin tax
      const subtotalBaseIva = priceBaseCentavos + iva; // Monto base + IVA, antes de comisi칩n
      const comision = Math.round(subtotalBaseIva * 0.05); // Comisi칩n del 5% sobre (montoBase + IVA)
      const ivaComision = Math.round(comision * 0.15); // IVA del 15% sobre la comisi칩n
      const totalDisplay = subtotalBaseIva + comision + ivaComision; // Total final para mostrar al usuario

      precioInput.value = `$${(totalDisplay / 100).toFixed(2)} (${numeroPersonas} persona${numeroPersonas !== 1 ? 's' : ''})`;
    }

    // --- Funci칩n para iniciar el pago comunic치ndose con Google Apps Script ---
    async function iniciarPagoConScript(priceBaseCentavosCalculado, fechaViaje) {
      // Muestra un mensaje al usuario y deshabilita el bot칩n para evitar clics dobles
      ppButtonDiv.innerHTML = 'Procesando pago... por favor espera.';
      btnPagar.disabled = true;

      const destinoSeleccionado = destinoSelect.value;
      const tipoExperiencia = tipoExperienciaSelect.value || "Est치ndar";

      // Recalcula los montos en centavos para PayPhone (esto es crucial para el payload)
      const ivaNormal = Math.round(priceBaseCentavosCalculado * 0.15);
      const subtotalBaseIva = priceBaseCentavosCalculado + ivaNormal;
      const comision = Math.round(subtotalBaseIva * 0.05);
      const ivaComision = Math.round(comision * 0.15);
      const amountWithTax = comision + ivaComision; // La suma de la comisi칩n y su IVA
      const totalAmount = subtotalBaseIva + amountWithTax; // El monto TOTAL que se enviar치 a PayPhone

      const paymentData = {
        amount: totalAmount, // TOTAL a cobrar por PayPhone (en centavos)
        amountWithoutTax: priceBaseCentavosCalculado, // El precio base sin IVA por el n칰mero de personas (en centavos)
        amountWithTax: amountWithTax, // La suma de la comisi칩n y su IVA (en centavos)
        tax: ivaNormal, // Solo el IVA del monto base (en centavos)
        currency: "USD",
        reference: `Reserva para ${destinoSeleccionado} (${tipoExperiencia}) - ${numeroPersonas} persona${numeroPersonas !== 1 ? 's' : ''} - Fecha: ${fechaViaje}`
      };

      try {
        // Realiza la petici칩n fetch a tu Google Apps Script
        // 'mode: no-cors' es esencial para evitar problemas de CORS con Apps Script como Web App
        // No esperamos leer la respuesta aqu칤, ya que el Apps Script se encargar치 de la redirecci칩n.
        const response = await fetch(GOOGLE_SCRIPT_WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded', // Formato de env칤o de datos
          },
          body: new URLSearchParams({ // Env칤a los datos como par치metros de formulario
            action: 'createPayment',
            data: JSON.stringify(paymentData) // Env칤a el objeto de datos de pago como una cadena JSON
          })
        });

        // Si la promesa de fetch se resuelve, significa que la solicitud fue enviada.
        // El Apps Script es el que debe encargarse de la redirecci칩n al cliente.
        ppButtonDiv.innerHTML = 'Solicitud enviada. Esperando redirecci칩n a PayPhone...';

      } catch (error) {
        // Si hay un error de red o similar al hacer el fetch
        console.error('Error al iniciar el pago (fetch):', error);
        ppButtonDiv.innerHTML = 'Error de conexi칩n. Por favor, intenta de nuevo.';
      } finally {
        // El bot칩n se habilitar치 de nuevo si no hubo una redirecci칩n inmediata,
        // o no importar치 si la p치gina ya se redirigi칩.
        btnPagar.disabled = false;
      }
    }

    // --- Event Listener para el bot칩n "Pagar con Tarjeta" ---
    btnPagar.addEventListener('click', () => {
      // Validaciones b치sicas antes de procesar el pago
      if (!regionSelect.value || regionSelect.value === "Elige una regi칩n") {
        alert("Por favor, selecciona una regi칩n.");
        regionSelect.focus();
        return;
      }
      if (!destinoSelect.value || destinoSelect.value === "Elige destino") {
        alert("Por favor, selecciona un destino.");
        destinoSelect.focus();
        return;
      }
      const destino = destinoSelect.value;
      if (tiposExperiencia[destino] && (!tipoExperienciaSelect.value || tipoExperienciaSelect.value === "Tipo de experiencia")) {
        alert("Por favor, selecciona un tipo de experiencia.");
        tipoExperienciaSelect.focus();
        return;
      }
      if (!fechaInput.value) {
        alert("Por favor, selecciona una fecha de viaje.");
        fechaInput.focus();
        return;
      }

      // Aseg칰rate de que el precio haya sido calculado y sea v치lido
      if (!priceBaseCentavos || precioInput.value === 'Consultar') {
        alert("Por favor, completa todos los campos correctamente para calcular el precio antes de pagar.");
        return;
      }

      // Llama a la funci칩n as칤ncrona para iniciar el proceso de pago
      iniciarPagoConScript(priceBaseCentavos, fechaInput.value);
    });

    // Funci칩n auxiliar para ajustar la altura del iframe si la p치gina est치 incrustada
    function ajustarAlturaIframe(altura) {
      if (window.parent) {
        window.parent.postMessage({ tipo: 'ajustarAltura', altura }, '*');
      }
    }
  </script>
</body>
</html>
