<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reserva y Pago</title>
  <!-- PayPhone -->
  <script src="https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.js" type="module"></script>
  <link href="https://cdn.payphonetodoesposible.com/box/v1.1/payphone-payment-box.css" rel="stylesheet" />
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    body {
      margin-top: 0rem; 
    }
    .container-fluid.booking {
      margin-top: 2rem;
      padding-bottom: 0rem;
    }
    .custom-select, .form-control {
      height: 47px;
    }
    #btn-pagar {
      margin-top: 1rem;
      height: 47px;
      width: 100%;
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    #btn-pagar:hover {
      background-color: #2dca4f;
    }
    #pp-button {
      margin-top: 1rem;
    }
    .flex-row-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .flex-row-inputs > * {
      flex: 1 1 100%;
    }
    @media (min-width: 768px) {
      body {
        margin-top: 7rem;
      }
      .flex-row-inputs > * {
        flex: 1 1 0;
      }
    }
    #region-select, #destino-select, #fecha-calendario, 
    #precio-pagar, #tipo-experiencia, #numero-personas {
      flex: 1 1 0;
      padding: 12px 15px;
      font-size: 1rem;
      border: 2px solid #b9b9b9;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background-color: #f9fff9;
      color: #155724;
      font-weight: 600;
      outline: none;
      margin: 0;
    }
    #region-select:focus, #destino-select:focus, 
    #fecha-calendario:focus, #precio-pagar:focus, 
    #tipo-experiencia:focus, #numero-personas:focus {
      border-color: #0f5132;
      box-shadow: 0 0 8px #0f5132aa;
      background-color: #e6f4ea;
    }
    #precio-pagar {
      background-color: #d4edda;
      cursor: not-allowed;
    }
    #fecha-calendario::placeholder,
    #precio-pagar::placeholder {
      color: #6c757d;
      font-weight: 400;
    }
    .fechas-disponibles {
      background-color: #d4edda !important;
      color: #155724 !important;
      border-radius: 50% !important;
      transition: all 0.2s ease;
    }
    .fechas-disponibles:hover {
      border: 2px solid #28a745 !important;
      box-shadow: 0 0 4px #28a745aa;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div>
    <div class="container-fluid booking">
      <div class="container">
        <div class="row align-items-center" style="min-height: 60px;">
          <div class="col-md-12">
            <div class="flex-row-inputs">
              <select id="region-select">
                <option selected disabled>Elige una región</option>
                <option value="Sierra">Sierra</option>
                <option value="Costa">Costa</option>
                <option value="Amazonía">Amazonía</option>
                <option value="Internacional">Internacional</option>
              </select>

              <select id="destino-select" disabled>
                <option selected disabled>Elige destino</option>
              </select>

              <select id="tipo-experiencia" disabled>
                <option selected disabled>Tipo de experiencia</option>
              </select>

              <input type="text" id="fecha-calendario" placeholder="Fecha salida" readonly disabled />
              <div style="position: relative; flex: 1 1 0; max-width: 100%;">
                <input
                  type="number"
                  id="numero-personas"
                  min="1"
                  max="99"
                  value="1"
                  placeholder="Número de personas"
                  style="padding-left: 60px; padding-right: 20px; width: 100%; font-size: 1rem; border: 2px solid #b9b9b9; border-radius: 12px; box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2); transition: border-color 0.3s ease, box-shadow 0.3s ease; background-color: #f9fff9; color: #155724; font-weight: 600; outline: none; height: 48px;">
                <span
                  style="position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; font-weight: 600; font-size: 1.2rem;">
                  👥
                </span>
              </div>
              <input type="text" id="precio-pagar" placeholder="Total a pagar" readonly />
            </div>
            <div class="row">
              <div class="col-md-12">
                <button id="btn-pagar" class="btn btn-success btn-block" style="height: 47px;">
                  Pagar con Tarjeta
                </button>
                <div id="pp-button"></div>
              </div>
            </div>
          </div>
        </div>
      </div>    
    </div>
  </div>

  <script>
    // Funciones para generar fechas disponibles
    function generarFechasBañosTodoIncluido() {
      const fechasManuales = [
        '2025-06-15', '2025-06-19', '2025-06-22', '2025-06-26',
        '2025-06-29', '2025-07-03', '2025-07-06', '2025-07-10',
        '2025-07-13', '2025-07-17', '2025-07-20', '2025-07-24',
        '2025-07-27', '2025-07-31', '2025-08-03', '2025-08-07',
        '2025-08-10', '2025-08-14', '2025-08-17', '2025-08-21',
        '2025-08-24', '2025-08-28', '2025-08-31'
      ];
      
      const fechasValidas = [];
      const ahora = new Date();
      
      for (const fechaStr of fechasManuales) {
        const fecha = new Date(fechaStr);
        const fechaCorte = new Date(fecha);
        fechaCorte.setDate(fechaCorte.getDate() - 1);
        fechaCorte.setHours(17, 0, 0, 0);
        
        if (ahora <= fechaCorte) {
          fechasValidas.push(fechaStr);
        }
      }
      
      return fechasValidas;
    }

    function generarFechasBañosCompartido() {
      const fechasManuales = [
        '2025-06-18', '2025-06-21', '2025-06-25', '2025-06-28',
        '2025-07-02', '2025-07-05', '2025-07-09', '2025-07-12',
        '2025-07-16', '2025-07-19', '2025-07-23', '2025-07-26',
        '2025-07-30', '2025-08-02', '2025-08-06', '2025-08-09',
        '2025-08-13', '2025-08-16', '2025-08-20', '2025-08-23',
        '2025-08-27', '2025-08-30'
      ];
      
      const fechasValidas = [];
      const ahora = new Date();
      
      for (const fechaStr of fechasManuales) {
        const fecha = new Date(fechaStr);
        const fechaCorte = new Date(fecha);
        fechaCorte.setDate(fechaCorte.getDate() - 1);
        fechaCorte.setHours(17, 0, 0, 0);
        
        if (ahora <= fechaCorte) {
          fechasValidas.push(fechaStr);
        }
      }
      
      return fechasValidas;
    }

    // Datos de la aplicación
    const fechasDisponibles = {
      "Baños de Agua Santa": function(tipoExperiencia) {
        if (tipoExperiencia === "Todo Incluido") {
          return generarFechasBañosTodoIncluido();
        } else if (tipoExperiencia === "Compartido") {
          return generarFechasBañosCompartido();
        }
        return [];
      },
      // Otras funciones de fechas...
    };

    const regiones = {
      "Sierra": ["Cotopaxi", "Cuenca", "Chimborazo", "Quilotoa", "Papallacta", "Mitad del Mundo"],
      "Amazonía": ["Misahualli", "Baños de Agua Santa", "Cotundo"],
      "Internacional": ["Proximamente"],
      "Costa": ["Puerto Lopez", "Atacames"]
    };

    const tiposExperiencia = {
      "Baños de Agua Santa": ["Todo Incluido", "Compartido"],
      // Otros tipos de experiencia...
      "_default": ["Todo Incluido"]
    };

    const preciosBase = {
      "Baños de Agua Santa": {
        "Todo Incluido": {
          finDeSemana: 30,
          entreSemana: 60
        },
        "Compartido": {
          finDeSemana: 100,
          entreSemana: 200
        }
      },
      // Otros precios...
    };

    // Elementos del DOM
    const regionSelect = document.getElementById('region-select');
    const destinoSelect = document.getElementById('destino-select');
    const tipoExperienciaSelect = document.getElementById('tipo-experiencia');
    const fechaInput = document.getElementById('fecha-calendario');
    const numeroPersonasInput = document.getElementById('numero-personas');
    const precioInput = document.getElementById('precio-pagar');
    const btnPagar = document.getElementById('btn-pagar');

    // Variables globales
    let priceBaseCentavos = 0;
    let numeroPersonas = 1;
    let calendario;

    // Event Listeners
    regionSelect.addEventListener('change', () => {
      const destinos = regiones[regionSelect.value] || [];
      destinoSelect.innerHTML = '<option selected disabled>Elige destino</option>';
      destinos.forEach(dest => {
        const opt = document.createElement('option');
        opt.value = dest;
        opt.textContent = dest;
        destinoSelect.appendChild(opt);
      });
      destinoSelect.disabled = destinos.length === 0;
      tipoExperienciaSelect.innerHTML = '<option selected disabled>Tipo de experiencia</option>';
      tipoExperienciaSelect.disabled = true;
      fechaInput.value = '';
      fechaInput.disabled = true;
      precioInput.value = '';
      if (calendario) calendario.destroy();
      document.getElementById("pp-button").innerHTML = "";
    });

    destinoSelect.addEventListener('change', () => {
      const destino = destinoSelect.value;
      const tipos = tiposExperiencia[destino] || tiposExperiencia["_default"];
      tipoExperienciaSelect.innerHTML = '<option selected disabled>Tipo de experiencia</option>';
      tipos.forEach(tipo => {
        const opt = document.createElement('option');
        opt.value = tipo;
        opt.textContent = tipo;
        tipoExperienciaSelect.appendChild(opt);
      });
      tipoExperienciaSelect.disabled = tipos.length === 0;
      fechaInput.value = '';
      fechaInput.disabled = true;
      precioInput.value = '';
      if (calendario) calendario.destroy();
      document.getElementById("pp-button").innerHTML = "";
    });

    tipoExperienciaSelect.addEventListener('change', () => {
      const destino = destinoSelect.value;
      const tipoExperiencia = tipoExperienciaSelect.value;
      
      let fechas;
      if (typeof fechasDisponibles[destino] === 'function') {
        fechas = fechasDisponibles[destino](tipoExperiencia);
      } else {
        fechas = fechasDisponibles[destino];
      }
      
      if (calendario) calendario.destroy();

      if (fechas) {
        calendario = flatpickr(fechaInput, {
          dateFormat: "Y-m-d",
          minDate: "today",
          enable: fechas,
          onOpen: () => {
            ajustarAlturaIframe(400);
          },
          onClose: () => {
            ajustarAlturaIframe(190);
          },
          onDayCreate: function (dObj, dStr, fp, dayElem) {
            const fecha = dayElem.dateObj.toISOString().split('T')[0];
            if (fechas.includes(fecha)) {
              dayElem.classList.add('fechas-disponibles');
            }
          }
        });
      } else {
        calendario = flatpickr(fechaInput, {
          dateFormat: "Y-m-d",
          minDate: "today",
          onOpen: () => {
            ajustarAlturaIframe(400);
          },
          onClose: () => {
            ajustarAlturaIframe(190);
          }
        });
      }

      fechaInput.disabled = false;
      precioInput.value = '';
      document.getElementById("pp-button").innerHTML = "";
    });

    fechaInput.addEventListener('change', () => {
      calcularYMostrarPrecio();
      document.getElementById("pp-button").innerHTML = "";
    });

    numeroPersonasInput.addEventListener('change', () => {
      if (fechaInput.value) {
        calcularYMostrarPrecio();
        document.getElementById("pp-button").innerHTML = "";
      }
    });

    // Función para calcular el precio corregida
    function calcularYMostrarPrecio() {
      const destino = destinoSelect.value;
      const tipoExperiencia = tipoExperienciaSelect.value;
      const fecha = fechaInput.value;
      numeroPersonas = parseInt(numeroPersonasInput.value) || 1;
      
      if (!destino || !fecha) {
        precioInput.value = '';
        return;
      }

      const fechaObj = new Date(fecha);
      const diaSemana = fechaObj.getDay();
      const esFinDeSemana = (diaSemana === 6 || diaSemana === 0); // 0 es domingo, 6 es sábado

      let precioBase;
      const precioDestino = preciosBase[destino];

      // Lógica específica para Baños de Agua Santa
      if (destino === "Baños de Agua Santa" && precioDestino && precioDestino[tipoExperiencia]) {
        precioBase = esFinDeSemana ? 
          precioDestino[tipoExperiencia].finDeSemana : 
          precioDestino[tipoExperiencia].entreSemana;
      } 
      // Lógica para otros destinos...
      else if (typeof precioDestino === 'object' && precioDestino[tipoExperiencia] !== undefined) {
        precioBase = precioDestino[tipoExperiencia];
      } else if (typeof precioDestino === 'number') {
        precioBase = precioDestino;
      } else {
        precioBase = 0;
      }

      if (!precioBase) {
        precioInput.value = 'Consultar';
        return;
      }

      priceBaseCentavos = Math.round(precioBase * 100) * numeroPersonas;

      const iva = priceBaseCentavos * 0.15;
      const subtotal = priceBaseCentavos + iva;
      const comision = subtotal * 0.05;
      const ivaComision = comision * 0.15;
      const total = subtotal + comision + ivaComision;

      precioInput.value = `$${(total / 100).toFixed(2)} (${numeroPersonas} persona${numeroPersonas !== 1 ? 's' : ''})`;
    }

    // Resto del código (event listeners para el botón de pago, etc.)
    btnPagar.addEventListener('click', () => {
      if (!regionSelect.value) {
        alert("Por favor, selecciona una región.");
        regionSelect.focus();
        return;
      }
      
      if (!destinoSelect.value || destinoSelect.value === "Elige destino") {
        alert("Por favor, selecciona un destino.");
        destinoSelect.focus();
        return;
      }
      
      const destino = destinoSelect.value;
      if (tiposExperiencia[destino] && (!tipoExperienciaSelect.value || tipoExperienciaSelect.value === "Tipo de experiencia")) {
        alert("Por favor, selecciona un tipo de experiencia.");
        tipoExperienciaSelect.focus();
        return;
      }
      
      if (!fechaInput.value) {
        alert("Por favor, selecciona una fecha de viaje.");
        fechaInput.focus();
        return;
      }
      
      if (!priceBaseCentavos || precioInput.value === 'Consultar') {
        alert("Por favor, completa todos los campos correctamente para calcular el precio.");
        return;
      }
      
      ajustarAlturaIframe(600);
      generarBotonPago(priceBaseCentavos, fechaInput.value);
    });

    // URL de tu Google Apps Script (REEMPLAZA CON TU URL REAL)
    const PAYPHONE_API_URL = 'https://script.google.com/macros/s/AKfycbzisbTJzxPkKuB10lb3D8XHL-WN7p9y1isAf9UBvtWg/dev';

    /**
     * Obtiene las credenciales de PayPhone desde Google Apps Script
     */
 // --- Tu código HTML/JavaScript en tu frontend ---

/**
 * Obtiene las credenciales de PayPhone llamando a tu aplicación web de Google Apps Script.
 * Retorna una Promesa que se resuelve con el token y storeId, o se rechaza en caso de error.
 */
function obtenerCredencialesPayPhone() {
  return new Promise((resolve, reject) => {
    // ***** IMPORTANTE: Reemplaza esta URL con la URL de despliegue de tu Google Apps Script. *****
    // Es la URL que termina en /exec.
    const YOUR_APPS_SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby8ixUPK5zpuT7ck71kTJ1IzDHACU5q9oUtkpmR5EtXKsHysCv47EmY1_Fz6NRDztVDgQ/exec';

    const script = document.createElement('script');
    // Asegúrate que el parámetro 'origin' coincida con el dominio de tu frontend
    script.src = `${YOUR_APPS_SCRIPT_WEB_APP_URL}?origin=${encodeURIComponent(window.location.origin)}&callback=handlePayPhoneCredentials`;

    // Define la función de callback global que el script de Google Apps Script llamará
    window.handlePayPhoneCredentials = (data) => {
      document.body.removeChild(script); // Limpia el script del DOM
      delete window.handlePayPhoneCredentials; // Elimina la función global

      if (data.token && data.storeId) {
        resolve(data); // Resuelve la promesa con las credenciales
      } else if (data.error) {
        reject(new Error('Error del script de Apps Script: ' + data.error)); // Rechaza si el script reporta un error
      } else {
        reject(new Error('Credenciales incompletas o formato inesperado recibido.'));
      }
    };

    // Manejo de errores si el script no se carga
    script.onerror = () => {
        document.body.removeChild(script);
        delete window.handlePayPhoneCredentials;
        reject(new Error('Error al cargar el script de credenciales de PayPhone desde Google Apps Script.'));
    };

    document.body.appendChild(script); // Añade el script al DOM para que se ejecute
  });
}

/**
 * Ejemplo de cómo usar la función obtenerCredencialesPayPhone.
 * Llama a esta función cuando necesites las credenciales para inicializar PayPhone.
 */
async function iniciarProcesoConPayPhone() {
  console.log('Intentando obtener credenciales de PayPhone...');
  try {
    const credenciales = await obtenerCredencialesPayPhone();
    console.log('Credenciales de PayPhone obtenidas con éxito:');
    console.log('Token:', credenciales.token);
    console.log('Store ID:', credenciales.storeId);

    // --- AQUÍ ES DONDE USARÍAS TUS CREDENCIALES ---
    // Por ejemplo, para inicializar el SDK de PayPhone:
    // payphone.init({ token: credenciales.token, storeId: credenciales.storeId });

    // O para realizar una llamada a la API que requiera el token:
    // const response = await fetch('https://payphone.com/api/some_endpoint', {
    //   method: 'POST',
    //   headers: {
    //     'Authorization': `Bearer ${credenciales.token}`,
    //     'Content-Type': 'application/json'
    //   },
    //   body: JSON.stringify({ /* tus datos de pago */ })
    // });
    // const result = await response.json();
    // console.log('Resultado de la API de PayPhone:', result);

  } catch (error) {
    console.error('Error al obtener o usar credenciales de PayPhone:', error.message);
    // Aquí puedes mostrar un mensaje de error al usuario en tu interfaz
    alert('No se pudieron cargar las credenciales de pago. Por favor, inténtelo de nuevo más tarde.');
  }
}

// Llama a la función para iniciar el proceso cuando sea apropiado,
// por ejemplo, al cargar la página o al hacer clic en un botón de pago.
// iniciarProcesoConPayPhone(); // Puedes descomentar esta línea para probarlo al cargar la página
async function testAPI() {
  try {
    const test = await fetch(PAYPHONE_API_URL);
    console.log("Respuesta cruda:", test);
    
    const data = await test.json();
    console.log("Datos recibidos:", data);
    
    return true;
  } catch (error) {
    console.error("Error en testAPI:", error);
    return false;
  }
}

// Ejecuta el test al cargar la página
window.addEventListener('DOMContentLoaded', async () => {
  const apiFunciona = await testAPI();
  console.log("¿API funciona?", apiFunciona);
});
    /**
     * Genera el botón de pago con credenciales seguras
     */
    async function generarBotonPago(priceBase, fechaViaje) {
      try {
        // 1. Obtener credenciales de forma segura
        const { token, storeId } = await obtenerCredencialesPayPhone();
        
        // 2. Calcular montos (lógica existente)
        const ivaNormal = Math.round(priceBase * 0.15);
        const subtotal = priceBase + ivaNormal;
        const comision = Math.round(subtotal * 0.05);
        const ivaComision = Math.round(comision * 0.15);
        const totalAmount = subtotal + comision + ivaComision;

        // 3. Renderizar botón de pago
        document.getElementById("pp-button").innerHTML = "";
        
        const pago = new PPaymentButtonBox({
          token: token, // ✅ Credencial segura
          storeId: storeId, // ✅ Credencial segura
          clientTransactionId: `TRANS-${Date.now()}-${Math.floor(Math.random() * 100000)}`,
          amount: totalAmount,
          amountWithoutTax: priceBase,
          amountWithTax: comision + ivaComision,
          tax: ivaNormal,
          currency: "USD",
          reference: `Reserva para ${destinoSelect.value} (${tipoExperienciaSelect.value || "Estándar"}) - ${numeroPersonas} persona${numeroPersonas !== 1 ? 's' : ''} - Fecha: ${fechaViaje}`,
          onSuccess: (response) => {
            console.log("Pago exitoso:", response);
            // Aquí puedes redirigir o mostrar mensaje de éxito
          },
          onError: (error) => {
            console.error("Error en pago:", error);
            alert("Error al procesar el pago. Por favor intente nuevamente.");
          }
        });

        pago.render('pp-button');

        setTimeout(() => {
          ajustarAlturaIframe(1000);
        }, 500);

      } catch (error) {
        console.error("Error en generarBotonPago:", error);
        alert("No se pudo iniciar el proceso de pago. Por favor recargue la página.");
        // Opcional: Mostrar UI de error al usuario
      }
    }

    function ajustarAlturaIframe(altura) {
      window.parent.postMessage({ tipo: 'ajustarAltura', altura }, '*');
    }
  </script>
</body>
</html>
